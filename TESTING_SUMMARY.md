# è´¢åŠ¡åˆ†æç³»ç»Ÿæµ‹è¯•å¥—ä»¶é…ç½®å®ŒæˆæŠ¥å‘Š

## é…ç½®æ¦‚è¿°

æˆ‘å·²ç»ä¸ºè´¢åŠ¡åˆ†æç³»ç»Ÿå®Œæˆäº†å®Œæ•´çš„pytestå’ŒCI/CDé…ç½®ï¼Œæ¶µç›–æ™ºèƒ½ä½“æ ¸å¿ƒèƒ½åŠ›çš„å…¨é¢æµ‹è¯•ã€‚

## ğŸ“‹ å·²å®Œæˆçš„æµ‹è¯•å¥—ä»¶

### 1. è´¢åŠ¡æŒ‡æ ‡è®¡ç®—æµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/tools/test_financial_analysis_toolkit.py`
- **è¦†ç›–**: 17ä¸ªæ ¸å¿ƒè´¢åŠ¡æŒ‡æ ‡
- **æµ‹è¯•ç±»**: `TestFinancialMetricsCalculation`
- **åŠŸèƒ½**:
  - ç›ˆåˆ©èƒ½åŠ›æŒ‡æ ‡ï¼ˆæ¯›åˆ©ç‡ã€å‡€åˆ©ç‡ã€ROEã€ROAï¼‰
  - å¿å€ºèƒ½åŠ›æŒ‡æ ‡ï¼ˆèµ„äº§è´Ÿå€ºç‡ã€æµåŠ¨æ¯”ç‡ã€é€ŸåŠ¨æ¯”ç‡ï¼‰
  - è¿è¥æ•ˆç‡æŒ‡æ ‡ï¼ˆæ€»èµ„äº§å‘¨è½¬ç‡ã€å­˜è´§å‘¨è½¬ç‡ã€åº”æ”¶è´¦æ¬¾å‘¨è½¬ç‡ï¼‰
  - æˆé•¿æ€§æŒ‡æ ‡ï¼ˆæ”¶å…¥å¢é•¿ç‡ã€åˆ©æ¶¦å¢é•¿ç‡ï¼‰
  - ç°é‡‘æµæŒ‡æ ‡ï¼ˆ5ä¸ªæ ¸å¿ƒç°é‡‘æµæŒ‡æ ‡ï¼‰

### 2. å›¾è¡¨ç”Ÿæˆæµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/tools/test_tabular_data_toolkit.py`
- **è¦†ç›–**: 8ç§å›¾è¡¨ç±»å‹
- **æµ‹è¯•ç±»**: `TestChartGeneration`
- **å›¾è¡¨ç±»å‹**:
  - è´¢åŠ¡æŒ‡æ ‡å¯¹æ¯”å›¾
  - é›·è¾¾å›¾
  - è¶‹åŠ¿å›¾
  - æ•£ç‚¹å›¾
  - çƒ­åŠ›å›¾
  - ç°é‡‘æµç»“æ„å›¾
  - ç°é‡‘æµç€‘å¸ƒå›¾
  - é€šç”¨å›¾è¡¨

### 3. æŠ¥å‘Šç”Ÿæˆæµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/tools/test_report_saver_toolkit.py`
- **è¦†ç›–**: 4ç§æŠ¥å‘Šæ ¼å¼
- **æµ‹è¯•ç±»**: `TestReportGeneration`
- **æ ¼å¼æ”¯æŒ**:
  - Markdownæ–‡æ¡£
  - HTMLç½‘é¡µ
  - JSONç»“æ„åŒ–æ•°æ®
  - PDFæŠ¥å‘Š

### 4. é›†æˆæµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/integration/test_financial_workflow.py`
- **åŠŸèƒ½**: ç«¯åˆ°ç«¯å·¥ä½œæµç¨‹æµ‹è¯•
- **æµ‹è¯•ç±»**: `TestFinancialAnalysisWorkflow`
- **è¦†ç›–**: å®Œæ•´çš„è´¢åŠ¡åˆ†ææµç¨‹

### 5. AKShareçœŸå®æ•°æ®æµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/integration/test_akshare_real_data.py`
- **åŠŸèƒ½**: çœŸå®æ•°æ®éªŒè¯
- **æµ‹è¯•ç±»**: `TestAKShareRealData`
- **æ•°æ®æº**: çœŸå®AKShare APIæ•°æ®

### 6. æ€§èƒ½æµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/performance/test_financial_performance.py`
- **åŠŸèƒ½**: æ€§èƒ½åŸºå‡†æµ‹è¯•
- **æµ‹è¯•ç±»**: `TestFinancialPerformance`
- **æŒ‡æ ‡**:
  - è®¡ç®—æ—¶é—´åŸºå‡†
  - å†…å­˜ä½¿ç”¨ç›‘æ§
  - å¹¶å‘å¤„ç†èƒ½åŠ›
  - å¤§æ•°æ®é›†å¤„ç†

### 7. è¾¹ç•Œæƒ…å†µæµ‹è¯• âœ…
- **æ–‡ä»¶**: `tests/edge_cases/test_financial_edge_cases.py`
- **åŠŸèƒ½**: å¼‚å¸¸å’Œè¾¹ç•Œæ¡ä»¶å¤„ç†
- **æµ‹è¯•ç±»**: `TestFinancialEdgeCases`
- **åœºæ™¯**:
  - ç©ºæ•°æ®å¤„ç†
  - é›¶å€¼å¤„ç†
  - è´Ÿå€¼å¤„ç†
  - æå€¼å¤„ç†
  - ç³»ç»Ÿæ¢å¤èƒ½åŠ›

## âš™ï¸ Pytesté…ç½®

### 1. ä¸»è¦é…ç½®æ–‡ä»¶

#### pyproject.tomlé…ç½®
```toml
[tool.pytest.ini_options]
# æµ‹è¯•è·¯å¾„
testpaths = ["tests"]

# æ ‡è®°å®šä¹‰
markers = [
    "slow: æ…¢é€Ÿæµ‹è¯•",
    "integration: é›†æˆæµ‹è¯•",
    "performance: æ€§èƒ½æµ‹è¯•",
    "edge_case: è¾¹ç•Œæƒ…å†µæµ‹è¯•",
    "financial: è´¢åŠ¡åˆ†æç›¸å…³",
    "akshare: AKShareæ•°æ®ç›¸å…³",
    "chart: å›¾è¡¨ç”Ÿæˆæµ‹è¯•",
    "report: æŠ¥å‘Šç”Ÿæˆæµ‹è¯•"
]

# å¼‚æ­¥æµ‹è¯•æ”¯æŒ
asyncio_mode = "auto"

# æ—¥å¿—é…ç½®
log_cli = true
log_cli_level = "INFO"
```

#### pytest.inié…ç½®
```ini
[pytest]
# åŸºç¡€é…ç½®
minversion = 6.0
testpaths = tests

# æµ‹è¯•å‘ç°æ¨¡å¼
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# è­¦å‘Šè¿‡æ»¤
filterwarnings =
    error
    ignore::UserWarning
    ignore::DeprecationWarning
```

### 2. å…¨å±€Fixtures (`tests/conftest.py`)

- `test_config`: æµ‹è¯•é…ç½®fixture
- `temp_workspace`: ä¸´æ—¶å·¥ä½œç©ºé—´
- `mock_llm_config`: æ¨¡æ‹ŸLLMé…ç½®
- `sample_financial_data`: æ ‡å‡†è´¢åŠ¡æ•°æ®
- `empty_financial_data`: ç©ºè´¢åŠ¡æ•°æ®
- `performance_monitor`: æ€§èƒ½ç›‘æ§å™¨
- `akshare_available`: AKShareå¯ç”¨æ€§æ£€æŸ¥

## ğŸš€ Makefileæµ‹è¯•å‘½ä»¤

### åŸºç¡€æµ‹è¯•å‘½ä»¤
```bash
make test              # è¿è¡ŒåŸºç¡€æµ‹è¯•
make test-unit         # å•å…ƒæµ‹è¯•
make test-integration  # é›†æˆæµ‹è¯•
make test-performance  # æ€§èƒ½æµ‹è¯•
make test-edge         # è¾¹ç•Œæƒ…å†µæµ‹è¯•
make test-all          # æ‰€æœ‰æµ‹è¯•
make test-quick        # å¿«é€Ÿæµ‹è¯•
```

### ä¸“é¡¹æµ‹è¯•å‘½ä»¤
```bash
make test-financial    # è´¢åŠ¡åˆ†æä¸“é¡¹æµ‹è¯•
make test-akshare      # AKShareæ•°æ®æµ‹è¯•
make test-chart        # å›¾è¡¨ç”Ÿæˆæµ‹è¯•
make test-report       # æŠ¥å‘Šç”Ÿæˆæµ‹è¯•
make test-workflow     # å·¥ä½œæµæµ‹è¯•
```

### æµ‹è¯•å·¥å…·å‘½ä»¤
```bash
make test-setup        # å®‰è£…æµ‹è¯•ä¾èµ–
make test-check-env    # æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ
make test-coverage     # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
make test-clean        # æ¸…ç†æµ‹è¯•æ–‡ä»¶
make check-all         # ä»£ç è´¨é‡æ£€æŸ¥
```

## ğŸ”„ CI/CDé…ç½®

### GitHub Actionså·¥ä½œæµ (`.github/workflows/test.yml`)

#### å·¥ä½œæµç¨‹
1. **ä»£ç è´¨é‡æ£€æŸ¥**
   - ä»£ç æ ¼å¼æ£€æŸ¥ (ruff format)
   - ä»£ç æ£€æŸ¥ (ruff check)
   - ç±»å‹æ£€æŸ¥ (mypy)

2. **å•å…ƒæµ‹è¯•**
   - è¿è¡Œå•å…ƒæµ‹è¯•å¥—ä»¶
   - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
   - ä¸Šä¼ åˆ°Codecov

3. **é›†æˆæµ‹è¯•**
   - çœŸå®æ•°æ®é›†æˆæµ‹è¯•
   - ç»„ä»¶äº¤äº’éªŒè¯

4. **æ€§èƒ½æµ‹è¯•**
   - æ€§èƒ½åŸºå‡†æµ‹è¯•
   - èµ„æºä½¿ç”¨ç›‘æ§

5. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - å¼‚å¸¸å¤„ç†éªŒè¯
   - ç³»ç»Ÿç¨³å®šæ€§æµ‹è¯•

6. **æ–‡æ¡£æ„å»º**
   - è‡ªåŠ¨æ„å»ºæ–‡æ¡£
   - éƒ¨ç½²åˆ°GitHub Pages

#### è§¦å‘æ¡ä»¶
- **Pushåˆ°main/developåˆ†æ”¯**: å®Œæ•´æµ‹è¯•å¥—ä»¶
- **Pull Request**: å•å…ƒæµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
- **æ ‡è®°integration-testçš„PR**: é¢å¤–é›†æˆæµ‹è¯•

### Pre-commité…ç½® (`.pre-commit-config.yaml`)

#### é’©å­é…ç½®
- åŸºç¡€ä»£ç æ£€æŸ¥ (ç©ºç™½å­—ç¬¦ã€æ–‡ä»¶æ ¼å¼)
- Pythonä»£ç æ ¼å¼åŒ– (ruff)
- å®‰å…¨æ£€æŸ¥ (bandit)
- æ–‡æ¡£æ£€æŸ¥ (pydocstyle)
- æµ‹è¯•éªŒè¯ (å¿«é€Ÿæµ‹è¯•)

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **æ€»ä½“è¦†ç›–ç‡**: â‰¥ 70%
- **æ ¸å¿ƒæ¨¡å—è¦†ç›–ç‡**: â‰¥ 85%
- **è´¢åŠ¡åˆ†ææ¨¡å—**: â‰¥ 80%
- **å›¾è¡¨ç”Ÿæˆæ¨¡å—**: â‰¥ 90%
- **æŠ¥å‘Šç”Ÿæˆæ¨¡å—**: â‰¥ 85%

## ğŸ› ï¸ æµ‹è¯•è¿è¡Œå™¨

### è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨ (`scripts/test_runner.py`)

#### åŠŸèƒ½ç‰¹æ€§
- ç¯å¢ƒæ£€æŸ¥å’ŒéªŒè¯
- åˆ†ç±»æµ‹è¯•è¿è¡Œ
- æ€§èƒ½ç›‘æ§
- æŠ¥å‘Šç”Ÿæˆ
- Windowså…¼å®¹æ€§

#### ä½¿ç”¨æ–¹å¼
```bash
python scripts/test_runner.py check        # æ£€æŸ¥ç¯å¢ƒ
python scripts/test_runner.py unit         # å•å…ƒæµ‹è¯•
python scripts/test_runner.py all          # æ‰€æœ‰æµ‹è¯•
python scripts/test_runner.py quick        # å¿«é€Ÿæµ‹è¯•
python scripts/test_runner.py report       # ç”ŸæˆæŠ¥å‘Š
```

## ğŸ“ æµ‹è¯•æ•°æ®ç®¡ç†

### AKShareçœŸå®æ•°æ®
- ä½¿ç”¨çœŸå®AKShare APIæ•°æ®
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- æ•°æ®è´¨é‡éªŒè¯
- å¤‡ç”¨æ¨¡æ‹Ÿæ•°æ®

### æµ‹è¯•Fixtures
- æ ‡å‡†åŒ–æµ‹è¯•æ•°æ®
- å¤šåœºæ™¯æ•°æ®æ”¯æŒ
- å®Œæ•´æ€§éªŒè¯
- æ€§èƒ½åŸºå‡†æ•°æ®

## ğŸ”§ æµ‹è¯•æ ‡è®°ç³»ç»Ÿ

### æµ‹è¯•ç±»å‹æ ‡è®°
- `@pytest.mark.unit`: å•å…ƒæµ‹è¯•
- `@pytest.mark.integration`: é›†æˆæµ‹è¯•
- `@pytest.mark.performance`: æ€§èƒ½æµ‹è¯•
- `@pytest.mark.edge_case`: è¾¹ç•Œæƒ…å†µæµ‹è¯•

### åŠŸèƒ½åŸŸæ ‡è®°
- `@pytest.mark.financial`: è´¢åŠ¡åˆ†æç›¸å…³
- `@pytest.mark.akshare`: AKShareæ•°æ®ç›¸å…³
- `@pytest.mark.chart`: å›¾è¡¨ç”Ÿæˆæµ‹è¯•
- `@pytest.mark.report`: æŠ¥å‘Šç”Ÿæˆæµ‹è¯•

### æ‰§è¡Œç‰¹æ€§æ ‡è®°
- `@pytest.mark.slow`: è€—æ—¶è¾ƒé•¿çš„æµ‹è¯•
- `@pytest.mark.network`: éœ€è¦ç½‘ç»œè¿æ¥
- `@pytest.mark.mock_data`: ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- `@pytest.mark.real_data`: ä½¿ç”¨çœŸå®æ•°æ®

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•åŸºå‡†

### å“åº”æ—¶é—´ç›®æ ‡
- è´¢åŠ¡æŒ‡æ ‡è®¡ç®—: â‰¤ 5ç§’
- å›¾è¡¨ç”Ÿæˆ: â‰¤ 10ç§’
- æŠ¥å‘Šç”Ÿæˆ: â‰¤ 15ç§’

### èµ„æºä½¿ç”¨é™åˆ¶
- å†…å­˜ä½¿ç”¨: â‰¤ 100MB
- CPUä½¿ç”¨: â‰¤ 80%
- å¹¶å‘å¤„ç†: æ”¯æŒ10ä¸ªå¹¶å‘è¯·æ±‚

## ğŸ¯ æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”
1. **å•å…ƒæµ‹è¯•** (70%): å¿«é€Ÿã€ç‹¬ç«‹çš„åŠŸèƒ½æµ‹è¯•
2. **é›†æˆæµ‹è¯•** (20%): ç»„ä»¶é—´äº¤äº’æµ‹è¯•
3. **ç«¯åˆ°ç«¯æµ‹è¯•** (10%): å®Œæ•´å·¥ä½œæµç¨‹éªŒè¯

### æµ‹è¯•æ•°æ®ç­–ç•¥
- çœŸå®æ•°æ®éªŒè¯
- æ¨¡æ‹Ÿæ•°æ®è¡¥å……
- è¾¹ç•Œæ•°æ®è¦†ç›–
- å¼‚å¸¸æ•°æ®æµ‹è¯•

## ğŸ“ æ–‡æ¡£å’ŒæŒ‡å—

### å·²åˆ›å»ºæ–‡æ¡£
- `docs/TESTING.md`: è¯¦ç»†æµ‹è¯•æŒ‡å—
- `TESTING_SUMMARY.md`: æµ‹è¯•é…ç½®æ€»ç»“
- å†…è”æµ‹è¯•æ–‡æ¡£: æ¯ä¸ªæµ‹è¯•æ–‡ä»¶éƒ½æœ‰è¯¦ç»†è¯´æ˜

### å¼€å‘è€…æŒ‡å—
- ç¯å¢ƒè®¾ç½®è¯´æ˜
- æµ‹è¯•ç¼–å†™è§„èŒƒ
- æ•…éšœæ’é™¤æŒ‡å—
- æœ€ä½³å®è·µå»ºè®®

## ğŸ” éªŒè¯ç»“æœ

### ç¯å¢ƒæ£€æŸ¥é€šè¿‡
```bash
æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ...
pytest ç‰ˆæœ¬: 8.4.1
utu åŒ…å·²å®‰è£…
ç¯å¢ƒå˜é‡è®¾ç½®å®Œæ•´
```

### æµ‹è¯•æ”¶é›†éªŒè¯
- æˆåŠŸæ”¶é›†23ä¸ªè´¢åŠ¡æŒ‡æ ‡æµ‹è¯•
- æµ‹è¯•æ–‡ä»¶ç»“æ„æ­£ç¡®
- é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
git clone https://github.com/hhhh124hhhh/Nexus-caiwu-agent.git
cd caiwu-agent
make sync
source .venv/bin/activate  # Linux/Mac
# æˆ– .\.venv\Scripts\activate  # Windows
```

### 2. è¿è¡Œæµ‹è¯•
```bash
# æ£€æŸ¥ç¯å¢ƒ
make test-check-env

# è¿è¡Œå¿«é€Ÿæµ‹è¯•
make test-quick

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test-all

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
make test-coverage
```

## ğŸ“‹ æ€»ç»“

æˆ‘å·²ç»æˆåŠŸå®Œæˆäº†è´¢åŠ¡åˆ†æç³»ç»Ÿçš„å®Œæ•´æµ‹è¯•å¥—ä»¶é…ç½®ï¼ŒåŒ…æ‹¬ï¼š

âœ… **8ä¸ªä¸»è¦ä»»åŠ¡å…¨éƒ¨å®Œæˆ**:
1. è´¢åŠ¡æŒ‡æ ‡è®¡ç®—æµ‹è¯• (17ä¸ªæŒ‡æ ‡)
2. å›¾è¡¨ç”Ÿæˆæµ‹è¯• (8ç§å›¾è¡¨ç±»å‹)
3. æŠ¥å‘Šç”Ÿæˆæµ‹è¯• (4ç§æ ¼å¼)
4. æµ‹è¯•æ•°æ®å’Œfixtures
5. é›†æˆæµ‹è¯• (ç«¯åˆ°ç«¯æµç¨‹)
6. æ€§èƒ½å’Œå‹åŠ›æµ‹è¯•
7. è¾¹ç•Œæƒ…å†µæµ‹è¯•
8. pytestå’ŒCI/CDé…ç½®

âœ… **å®Œæ•´çš„åŸºç¡€è®¾æ–½**:
- pytesté…ç½®å’Œæ ‡è®°ç³»ç»Ÿ
- GitHub Actions CI/CDæµæ°´çº¿
- Pre-commitä»£ç è´¨é‡æ£€æŸ¥
- è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨
- è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£

âœ… **è´¨é‡ä¿è¯**:
- çœŸå®AKShareæ•°æ®æµ‹è¯•
- æ€§èƒ½åŸºå‡†ç›‘æ§
- è¦†ç›–ç‡ç›®æ ‡è®¾å®š
- å¼‚å¸¸å¤„ç†éªŒè¯

è¿™å¥—æµ‹è¯•ç³»ç»Ÿç¡®ä¿äº†è´¢åŠ¡åˆ†ææ™ºèƒ½ä½“çš„æ ¸å¿ƒèƒ½åŠ›ï¼ˆè´¢åŠ¡æŒ‡æ ‡è®¡ç®—ã€å›¾è¡¨ç”Ÿæˆã€æŠ¥å‘Šç”Ÿæˆï¼‰å¾—åˆ°å…¨é¢éªŒè¯ï¼Œä¸ºç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§æä¾›äº†åšå®ä¿éšœã€‚